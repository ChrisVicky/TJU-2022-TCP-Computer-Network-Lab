---
theme: ./path/to/theme.json
author: 刘锦帆
date: MMMM dd, YYYY
paging: Slide %d / %d
---

# Client 端流程图
```
                                                                                                  ┌─┐                                                         
                                               创建 SYN 包并发送(需要ack)                          │T│ destroytimer()
                                   tju_conn()├──────────────────────────────┐ tju_close()         │I│◄───────────────────────┐          
                                        ▲      等待 state = ESTABLIHSED     │     ▲                │M│ send_with_retransmit() │
 ┌─────────┐                            │                                   │     │  checktimer() │R│◄─────────────────────┐ │
 │ #CLIENT │──────┬──────────┬──────────┴───────────────────┬─────────────────────┘  ┌───────────►│R│                    发│ │                             
 │ THREAD  │      │          │                              ▼       创建 pkt│放入队列│   push_q()  ├─┤                    送│ │
 └─────────┘      │          │           ┌────────┐      tju_send()├────────│────────│───────────►│S│                    报│ │                                                  
                  │          ▼           │ #SEND  │                         │        │  get_pkt() │E│                    文│ │                                                   
                  │    tju_socket()├────►│ TRHEAD │─────────────────────────│────────┴────────────┤N├──────────────────────┘ │
                  │          │           └────────┘                         │            push_q() │D│                        │
                  │          │                                      发送窗口└────────────────────►│ │                         │
                  │          │                            ┌─────────────┴───────────────┐         │Q│                        │
                  │          │                              已发未确认       尚未发送             │U│                          │
                  │          │        ┌──────────────┐    ┌─────┴──────┐┌───────┴───────┐         │E│                        │
                  │          │      ┌► $sending_queue ─┐  ┌────────────┬┬───────────────┐         │U│                        │
                  │          │      │ ├──────────────┤ ├─►│ $timer_list││ $sending_queue│         │E│                        │
                  │          ▼      ├► $timer_list    ─┘  └────────────┴┴───────────────┘         └─┘                        │
                  │    $tju_socket ─┤ ├──────────────┴───────────────────────┐                                               │
                  │                 ├► $disorder_buff ───► AVL TREE: 乱序到达                                                 │
                  │                 │ ├──────────────────────────────────────┤                                               │
                  │                 └► $recv_buff     ───► BUFFER: 正序数据                                                   │
                  │                   └──────────────────────────────────────┘                                               │
                  │               ┌────────┐                                                                                 │
                  ▼               │ #RECV  │                                                                                 │
          startSmulation()├──────►│ THREAD │─────┤handle_packet()├─┬┤ack├────────────────────────────────────────────────────┘
                                  └────────┘                       │        
                                                                   └┤SYN & ACK├─►传回ACK，当前sock->state = ESTABLIHSED
```

---

# Server 端流程图
```
                                               ┌─────────────────────┐
                                             ┌► $half queue ─► 半连接 ◄───────────────────────────────────────────┐                         
                                $tju_socket──┤ ├─────────────────────┤                                            │
                                    ▲        └► $full queue ─► 全连接 ◄──────────────────────────────────────────┐│
                                    │          └─────────────────────┘    ┌┤ACK & SYN_RECV├─► state= ESTABLIHSED├┘│
                                    │              ▲    │                 │                                       │
                                    │              │    │                 ├┤SYN├─►传回SYN & ACK, state=SYN_RECV├──┘
                                    │              │    │                 │                                    
                                    │              │    │                 │                       ┌─┐ remove()                    
                                    │              │    ▼                 │               insert()│A│────────────┐       
                                    │           tju_accept()              │      ┌┤FUTURE├───────►│V│ find_next()│                     
                                tju_socket()         ▲                    │      │                │L│◄─────────┐ │         
                                    ▲     ┌────────┐ │                    │      │                └─┘          │ │                                                                     
                                    │     │ #RECV  │ │                    │      │          push()┌─┐          │ │                                                                       
                  startSmulation()├─│────►│ THREAD │─│──┤handle_packet()├─┴┤data├┼┤EXPECTED├─────►│R│──────────┘ │                                                                   
                       ▲            │     └────────┘ │                           │                │E│ push()     │
  ┌─────────┐          │            │                │                           └┤OLD├─►drop()   │C│◄───────────┘
  │ #SERVER │──────────┴────────────┴────────────────┴───────┬─────────────┐                      │V│             
  │ THREAD  │                                                ▼           从│buffer 中顺序读取      │ │             
  └─────────┘                                             tju_recv() ◄─────│──────────────────────┤B│             
                                                                           ▼                      │U│             
                                                                      tju_close()                 │F│             
                                                                                                  │F│             
                                                                                                  └─┘             
```
